
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Skin-Check</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4c1d95">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/192/cosmetic-brush.png">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root { 
            --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --muted: #94a3b8;
            --primary: #8b5cf6; --accent: #ec4899;
            --safe: #34d399; --danger: #f87171; --gold: #f59e0b;
            --nav-height: 70px;
        }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* VIEWS (Tabs) */
        .view { flex: 1; display: none; flex-direction: column; height: 100%; overflow: hidden; position: relative; }
        .view.active { display: flex; }

        /* Header */
        header { 
            padding: 1rem; text-align: center; 
            background: linear-gradient(135deg, #4c1d95 0%, #1e1b4b 100%); 
            box-shadow: 0 4px 20px rgba(76, 29, 149, 0.4);
            z-index: 20; padding-top: max(1rem, env(safe-area-inset-top));
        }
        header h1 { margin: 0; font-size: 1.2rem; letter-spacing: 1px; font-weight: 800; }

        /* SCANNER VIEW */
        #scanner-wrapper { 
            flex: 1; position: relative; background: #000; display: flex; align-items: center; justify-content: center; 
        }
        #reader { width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        
        .scan-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; align-items: center; justify-content: center;
            pointer-events: none; z-index: 10;
        }
        .scan-frame { 
            width: 70%; aspect-ratio: 1; border: 2px solid rgba(255,255,255,0.2); border-radius: 20px;
            box-shadow: 0 0 0 4000px rgba(0,0,0,0.7); position: relative;
        }
        .scan-frame::after {
            content: ''; position: absolute; inset: -3px; border: 3px solid var(--accent); border-radius: 20px;
            animation: pulse 2s infinite; clip-path: polygon(0% 0%, 100% 0%, 100% 20%, 0% 20%);
        }
        @keyframes pulse { 0% { top:0; opacity:0; } 50% { opacity:1; } 100% { top:100%; opacity:0; } }
        
        /* HISTORY VIEW */
        #history-list { 
            flex: 1; overflow-y: auto; padding: 1rem; padding-bottom: calc(var(--nav-height) + 20px); 
        }
        .h-item {
            background: var(--card); padding: 12px; border-radius: 12px; margin-bottom: 10px;
            display: flex; gap: 12px; align-items: center; cursor: pointer; border: 1px solid rgba(255,255,255,0.05);
        }
        .h-img { width: 50px; height: 50px; border-radius: 8px; background: #334155; object-fit: cover; }
        .h-info { flex: 1; }
        .h-name { font-weight: bold; font-size: 0.95rem; margin-bottom: 2px; }
        .h-brand { font-size: 0.8rem; color: var(--muted); }
        .h-date { font-size: 0.7rem; color: var(--muted); opacity: 0.7; }
        .h-risk { width: 10px; height: 10px; border-radius: 50%; }
        .bg-green { background: var(--safe); box-shadow: 0 0 5px var(--safe); }
        .bg-red { background: var(--danger); box-shadow: 0 0 5px var(--danger); }

        /* BOTTOM NAV */
        .bottom-nav {
            height: var(--nav-height); background: #1e1b4b;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: env(safe-area-inset-bottom); z-index: 50;
        }
        .nav-btn {
            background: none; border: none; color: var(--muted);
            font-size: 0.75rem; font-weight: 600;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            cursor: pointer; padding: 10px; width: 100%;
        }
        .nav-btn.active { color: var(--primary); }
        .nav-icon { font-size: 1.4rem; }

        /* RESULT SHEET */
        #result-sheet { 
            position: absolute; bottom: 0; left: 0; right: 0; 
            background: var(--card); border-radius: 25px 25px 0 0; 
            padding: 1.5rem; transform: translateY(110%); transition: 0.3s cubic-bezier(0.19, 1, 0.22, 1); 
            box-shadow: 0 -10px 50px rgba(0,0,0,0.6); z-index: 60; max-height: 85vh; overflow-y: auto;
            padding-bottom: max(2rem, env(safe-area-inset-bottom));
        }
        #result-sheet.open { transform: translateY(0); }
        
        /* Elements */
        .prod-img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); margin-right: 15px; background: white; }
        .badge { padding: 4px 10px; border-radius: 99px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; margin-right: 5px; }
        .b-safe { background: rgba(52, 211, 153, 0.1); color: var(--safe); }
        .b-danger { background: rgba(248, 113, 113, 0.1); color: var(--danger); }
        
        .inci-item { 
            background: rgba(255,255,255,0.03); padding: 12px; border-radius: 10px; margin-bottom: 8px; 
            display: flex; justify-content: space-between; align-items: center; border-left: 3px solid transparent;
            cursor: pointer; transition: background 0.2s;
        }
        .inci-danger { border-left-color: var(--danger); background: rgba(248, 113, 113, 0.05); }
        .inci-safe { border-left-color: var(--safe); }
        
        /* Buttons */
        .btn { width: 100%; padding: 15px; border: none; border-radius: 15px; font-weight: bold; margin-top: 1rem; cursor: pointer; }
        .btn-scan { background: rgba(255,255,255,0.1); color: white; }
        
        .btn-affiliate { 
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); 
            color: white; font-size: 1rem; 
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
            display: flex; align-items: center; justify-content: center; gap: 8px;
            text-decoration: none; animation: pop 0.3s ease-out; margin-bottom: 1rem;
        }
        
        .btn-share {
            background: rgba(236, 72, 153, 0.2); color: #f472b6; 
            margin-top: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px;
            text-decoration: none; padding: 15px; border-radius: 15px; font-weight: bold;
        }
        
        .feedback-area { margin-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem; text-align: center; }
        .btn-feedback { background: transparent; color: var(--muted); border: 1px solid rgba(255,255,255,0.1); font-size: 0.8rem; padding: 8px 16px; border-radius: 99px; text-decoration: none; display: inline-block; }
        
        @keyframes pop { 0% { transform: scale(0.9); opacity:0; } 100% { transform: scale(1); opacity:1; } }
        
    </style>
</head>
<body>

<header id="main-header"><h1>Skin-Check üíÑ</h1></header>

<div id="view-scan" class="view active">
    <div id="scanner-wrapper">
        <div id="reader"></div>
        <div class="scan-overlay"><div class="scan-frame"></div></div>
    </div>
</div>

<div id="view-history" class="view">
    <div id="history-list">
        <div style="text-align:center; padding: 3rem; color: var(--muted);">
            <div style="font-size:2rem; margin-bottom:1rem;">üï∞Ô∏è</div>
            Noch keine Scans.<br>Dein Verlauf erscheint hier.
        </div>
    </div>
</div>

<div class="bottom-nav">
    <button class="nav-btn active" onclick="switchTab('scan')">
        <span class="nav-icon">üì∑</span>
        Scanner
    </button>
    <button class="nav-btn" onclick="switchTab('history')">
        <span class="nav-icon">üìú</span>
        Verlauf
    </button>
</div>

<div id="result-sheet">
    <div style="width:40px; height:4px; background:#ffffff33; margin:0 auto 20px auto; border-radius:2px;"></div>
    <div id="content"></div>
    <button class="btn btn-scan" onclick="closeSheet()">Schlie√üen</button>
</div>

<script>
    const AMZ_TAG = "dein-tag-21";
    const LEXIKON_BASE = "lexikon";
    const FEEDBACK_MAIL = "feedback@skincheck.app";
    const APP_URL = "https://alexfractalnode.github.io/skin-check-app/";
    
    let db = {};
    let scanner = null;
    let isScanning = true;
    let historyData = JSON.parse(localStorage.getItem('skincheck_history') || '[]');

    fetch('app_database.json').then(r => r.json()).then(d => db = d);
    renderHistory(); // Init History

    // --- TABS ---
    function switchTab(tab) {
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        
        if(tab === 'scan') {
            document.getElementById('view-scan').classList.add('active');
            document.querySelectorAll('.nav-btn')[0].classList.add('active');
            document.getElementById('main-header').innerText = "Skin-Check üíÑ";
            startScan();
        } else {
            document.getElementById('view-history').classList.add('active');
            document.querySelectorAll('.nav-btn')[1].classList.add('active');
            document.getElementById('main-header').innerText = "Verlauf üï∞Ô∏è";
            stopScanner();
            renderHistory();
        }
    }

    // --- HISTORY ---
    function addToHistory(product, hasRisk) {
        // Duplikate entfernen
        historyData = historyData.filter(h => h.code !== product._id);
        
        const newItem = {
            code: product._id,
            name: product.product_name || 'Unbekannt',
            brand: product.brands || '',
            img: product.image_front_small_url || '',
            risk: hasRisk, // true/false
            date: new Date().toLocaleDateString()
        };
        
        historyData.unshift(newItem);
        if(historyData.length > 50) historyData.pop();
        
        localStorage.setItem('skincheck_history', JSON.stringify(historyData));
        renderHistory();
    }

    function renderHistory() {
        const list = document.getElementById('history-list');
        if(historyData.length === 0) return;
        
        list.innerHTML = '';
        historyData.forEach(item => {
            let riskClass = item.risk ? 'bg-red' : 'bg-green';
            list.innerHTML += `
            <div class="h-item" onclick="analyze('${item.code}')">
                <img src="${item.img || 'https://via.placeholder.com/50'}" class="h-img">
                <div class="h-info">
                    <div class="h-name">${item.name}</div>
                    <div class="h-brand">${item.brand}</div>
                    <div class="h-date">${item.date}</div>
                </div>
                <div class="h-risk ${riskClass}"></div>
            </div>`;
        });
    }

    // --- SCANNER ---
    function startScan() {
        document.getElementById('result-sheet').classList.remove('open');
        if(scanner) return;
        scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250, facingMode: "environment" });
        scanner.render(onScan, e => {});
        isScanning = true;
    }

    function stopScanner() {
        if(scanner) {
            try { scanner.clear(); } catch(e) {}
            scanner = null;
        }
        isScanning = false;
    }
    
    function closeSheet() {
        document.getElementById('result-sheet').classList.remove('open');
        // Wenn wir im Scanner Tab sind, Scanner neu starten
        if(document.getElementById('view-scan').classList.contains('active')) {
            startScan();
        }
    }

    function onScan(code) {
        if(!isScanning) return;
        isScanning = false;
        try { scanner.clear(); scanner = null; } catch(e){}
        if(navigator.vibrate) navigator.vibrate(50);
        analyze(code);
    }

    async function analyze(code) {
        const ui = document.getElementById('content');
        const sheet = document.getElementById('result-sheet');
        ui.innerHTML = '<p style="text-align:center">Analysiere...</p>';
        sheet.classList.add('open');

        try {
            const res = await fetch(`https://world.openbeautyfacts.org/api/v0/product/${code}.json`);
            const data = await res.json();

            if(data.status === 0) {
                ui.innerHTML = `
                    <div style="text-align:center; padding: 2rem 0;">
                        <div style="font-size:3rem;">ü§∑‚Äç‚ôÄÔ∏è</div>
                        <h3>Unbekanntes Produkt</h3>
                        <p style="color:var(--muted)">Barcode ${code} nicht gefunden.</p>
                        <a href="mailto:${FEEDBACK_MAIL}?subject=Neues%20Produkt%20${code}" class="btn btn-affiliate" style="background:var(--primary);">‚ûï Jetzt melden</a>
                    </div>`;
                return;
            }

            const p = data.product;
            const ingredients = p.ingredients_original_tags || p.ingredients_tags || [];
            
            // Checks
            const hasMicroplastics = ingredients.some(t => t.includes('acrylates') || t.includes('carbomer') || t.includes('nylon') || t.includes('polyethylene'));
            const hasPalmOil = (p.ingredients_from_palm_oil_n > 0);

            let listHtml = '';
            let riskCount = 0;

            if(ingredients.length > 0) {
                ingredients.forEach(tag => {
                    let inci = (tag.split(':')[1] || tag).toUpperCase().replace(/-/g, ' ');
                    let info = db[inci];
                    if(!info) info = Object.values(db).find(v => v.n.toUpperCase() === inci);

                    if(info) {
                        let style = "inci-safe";
                        if(info.r.includes("Bedenklich") || info.r.includes("Gef√§hrlich") || info.r.includes("Vorsicht")) {
                            style = "inci-danger";
                            riskCount++;
                        }
                        let slug = info.n.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
                        let link = `${LEXIKON_BASE}/${slug}.html`;
                        
                        listHtml += `
                        <div class="inci-item ${style}" onclick="window.open('${link}', '_blank')">
                            <div>
                                <div style="font-weight:bold; font-size:0.9rem;">${info.n}</div>
                                <div style="font-size:0.75rem; opacity:0.7;">${info.d}</div>
                            </div>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div style="font-size:1.2rem;">${style.includes('danger') ? '‚ö†Ô∏è' : '‚úÖ'}</div>
                                <span style="opacity:0.3">‚Ä∫</span>
                            </div>
                        </div>`;
                    }
                });
            } else {
                listHtml = '<div style="padding:1rem; text-align:center; opacity:0.5;">Keine INCI-Liste verf√ºgbar.</div>';
            }

            // HISTORY SPEICHERN
            addToHistory(p, (riskCount > 0 || hasMicroplastics));

            // ACTIONS
            let actionBtns = "";
            let shareText = `Check: ${(p.product_name||'Produkt')} ist safe! ‚úÖ`;
            
            if (riskCount > 0 || hasMicroplastics || hasPalmOil) {
                const cleanName = (p.product_name || '').replace(/[^a-zA-Z0-9 ]/g, '');
                const search = `Naturkosmetik Alternative ${cleanName}`;
                const link = `https://www.amazon.de/s?k=${encodeURIComponent(search)}&tag=${AMZ_TAG}`;
                
                shareText = `üò± ${(p.product_name||'Dieses Produkt')} enth√§lt bedenkliche Stoffe! Check es hier:`;
                
                actionBtns += `
                <a href="${link}" target="_blank" class="btn btn-affiliate">
                    <span>‚ú®</span> Gesunde Alternative finden ‚Üó
                </a>`;
            }
            
            const shareUrl = `https://wa.me/?text=${encodeURIComponent(shareText + " " + APP_URL)}`;
            actionBtns += `<a href="${shareUrl}" target="_blank" class="btn btn-share">üì§ Warnung teilen</a>`;

            const feedbackLink = `mailto:${FEEDBACK_MAIL}?subject=Fehler%20${p.product_name}&body=Barcode:${code}`;

            ui.innerHTML = `
                <div style="display:flex; align-items:center; margin-bottom:20px;">
                    <img src="${p.image_front_small_url || 'https://via.placeholder.com/80'}" class="prod-img">
                    <div>
                        <div style="font-size:0.8rem; text-transform:uppercase; color:var(--primary);">${p.brands || ''}</div>
                        <h2 style="margin:0; font-size:1.3rem; line-height:1.2;">${p.product_name || 'Produkt'}</h2>
                    </div>
                </div>

                <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
                    ${hasMicroplastics ? '<span class="badge b-danger">‚ö†Ô∏è Mikroplastik</span>' : ''}
                    ${riskCount > 0 ? `<span class="badge b-danger">‚ö†Ô∏è ${riskCount} Bedenklich</span>` : '<span class="badge b-safe">‚ú® Keine Risiken</span>'}
                </div>
                
                ${actionBtns}
                
                <h3 style="font-size:1rem; opacity:0.7; margin: 20px 0 10px 0;">Analyse</h3>
                <div style="display:flex; flex-direction:column; gap:5px;">
                    ${listHtml}
                </div>
                
                <div class="feedback-area">
                    <a href="${feedbackLink}" class="btn-feedback">üì¢ Fehler melden</a>
                </div>
            `;

        } catch(e) {
            ui.innerHTML = "Fehler: " + e;
        }
    }

    startScan();
</script>
</body>
</html>
